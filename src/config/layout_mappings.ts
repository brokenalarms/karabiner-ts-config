import { FromAndToKeyCode, LayerKeyParam } from 'karabiner.ts'
import { ProfileConfig } from './layout_config'

export type Layout = 'qwerty' | 'dvorak' | 'dvorak_logical'
export type LocationLayoutMap = Record<FromAndToKeyCode, FromAndToKeyCode>
export type LocationLayerMap = Record<LayerKeyParam, LayerKeyParam>
export interface LayerConfig {
  letter: LocationLayoutMap
  location: LocationLayoutMap
  layerLocation: LocationLayerMap
  profileName: string
}


// lower key mappings only
const layouts: Record<Layout, LocationLayoutMap> = {
  qwerty: {
    q: 'q',
    w: 'w',
    e: 'e',
    r: 'r',
    t: 't',
    y: 'y',
    u: 'u',
    i: 'i',
    o: 'o',
    p: 'p',
    a: 'a',
    s: 's',
    d: 'd',
    f: 'f',
    g: 'g',
    h: 'h',
    j: 'j',
    k: 'k',
    l: 'l',
    semicolon: 'semicolon',
    z: 'z',
    x: 'x',
    c: 'c',
    v: 'v',
    b: 'b',
    n: 'n',
    m: 'm',
    comma: 'comma',
    period: 'period',
    slash: 'slash',
    backslash: 'backslash',
    grave_accent_and_tilde: 'grave_accent_and_tilde',
    '1': '1',
    '2': '2',
    '3': '3',
    '4': '4',
    '5': '5',
    '6': '6',
    '7': '7',
    '8': '8',
    '9': '9',
    '0': '0',
    quote: 'quote',
    hyphen: 'hyphen',
    equal_sign: 'equal_sign',
    open_bracket: 'open_bracket',
    close_bracket: 'close_bracket',
    left_control: 'left_control',
    left_shift: 'left_shift',
    left_option: 'left_option',
    left_command: 'left_command',
    right_control: 'right_control',
    right_shift: 'right_shift',
    right_option: 'right_option',
    right_command: 'right_command',
    fn: 'fn',
    caps_lock: 'caps_lock',
    return_or_enter: 'return_or_enter',
    escape: 'escape',
    delete_or_backspace: 'delete_or_backspace',
    delete_forward: 'delete_forward',
    tab: 'tab',
    spacebar: 'spacebar',
    non_us_pound: 'non_us_pound',
    non_us_backslash: 'non_us_backslash',
    up_arrow: 'up_arrow',
    down_arrow: 'down_arrow',
    left_arrow: 'left_arrow',
    right_arrow: 'right_arrow',
    page_up: 'page_up',
    page_down: 'page_down',
    home: 'home',
    end: 'end',
    f1: 'f1',
    f2: 'f2',
    f3: 'f3',
    f4: 'f4',
    f5: 'f5',
    f6: 'f6',
    f7: 'f7',
    f8: 'f8',
    f9: 'f9',
    f10: 'f10',
    f11: 'f11',
    f12: 'f12',
    f13: 'f13',
    f14: 'f14',
    f15: 'f15',
    f16: 'f16',
    f17: 'f17',
    f18: 'f18',
    f19: 'f19',
    f20: 'f20',
    keypad_num_lock: 'keypad_num_lock',
    keypad_slash: 'keypad_slash',
    keypad_asterisk: 'keypad_asterisk',
    keypad_hyphen: 'keypad_hyphen',
    keypad_plus: 'keypad_plus',
    keypad_enter: 'keypad_enter',
    keypad_1: 'keypad_1',
    keypad_2: 'keypad_2',
    keypad_3: 'keypad_3',
    keypad_4: 'keypad_4',
    keypad_5: 'keypad_5',
    keypad_6: 'keypad_6',
    keypad_7: 'keypad_7',
    keypad_8: 'keypad_8',
    keypad_9: 'keypad_9',
    keypad_0: 'keypad_0',
    keypad_period: 'keypad_period',
    keypad_equal_sign: 'keypad_equal_sign',
    keypad_comma: 'keypad_comma',
    print_screen: 'print_screen',
    scroll_lock: 'scroll_lock',
    pause: 'pause',
    insert: 'insert',
    application: 'application',
    help: 'help',
    power: 'power',
    international1: 'international1',
    international3: 'international3',
    lang1: 'lang1',
    lang2: 'lang2',
    japanese_eisuu: 'japanese_eisuu',
    japanese_kana: 'japanese_kana',
    volume_down: 'volume_down',
    volume_up: 'volume_up',
    mute: 'mute',
    volume_decrement: 'volume_decrement',
    volume_increment: 'volume_increment',
  },
  dvorak: {
    q: 'quote',
    w: 'comma',
    e: 'period',
    r: 'p',
    t: 'y',
    y: 'f',
    u: 'g',
    i: 'c',
    o: 'r',
    p: 'l',
    a: 'a',
    s: 'o',
    d: 'e',
    f: 'u',
    g: 'i',
    h: 'd',
    j: 'h',
    k: 't',
    l: 'n',
    semicolon: 's',
    z: 'semicolon',
    x: 'q',
    c: 'j',
    v: 'k',
    b: 'x',
    n: 'b',
    m: 'm',
    comma: 'w',
    period: 'v',
    slash: 'z',
    grave_accent_and_tilde: 'grave_accent_and_tilde',
    '1': '1',
    '2': '2',
    '3': '3',
    '4': '4',
    '5': '5',
    '6': '6',
    '7': '7',
    '8': '8',
    '9': '9',
    '0': '0',
    quote: 'q',
    backslash: 'backslash',
    hyphen: 'hyphen',
    equal_sign: 'equal_sign',
    open_bracket: 'open_bracket',
    close_bracket: 'close_bracket',
    left_control: 'left_control',
    left_shift: 'left_shift',
    left_option: 'left_option',
    left_command: 'left_command',
    right_control: 'right_control',
    right_shift: 'right_shift',
    right_option: 'right_option',
    right_command: 'right_command',
    fn: 'fn',
    caps_lock: 'caps_lock',
    return_or_enter: 'return_or_enter',
    escape: 'escape',
    delete_or_backspace: 'delete_or_backspace',
    delete_forward: 'delete_forward',
    tab: 'tab',
    spacebar: 'spacebar',
    non_us_pound: 'non_us_pound',
    non_us_backslash: 'non_us_backslash',
    up_arrow: 'up_arrow',
    down_arrow: 'down_arrow',
    left_arrow: 'left_arrow',
    right_arrow: 'right_arrow',
    page_up: 'page_up',
    page_down: 'page_down',
    home: 'home',
    end: 'end',
    f1: 'f1',
    f2: 'f2',
    f3: 'f3',
    f4: 'f4',
    f5: 'f5',
    f6: 'f6',
    f7: 'f7',
    f8: 'f8',
    f9: 'f9',
    f10: 'f10',
    f11: 'f11',
    f12: 'f12',
    f13: 'f13',
    f14: 'f14',
    f15: 'f15',
    f16: 'f16',
    f17: 'f17',
    f18: 'f18',
    f19: 'f19',
    f20: 'f20',
    keypad_num_lock: 'keypad_num_lock',
    keypad_slash: 'keypad_slash',
    keypad_asterisk: 'keypad_asterisk',
    keypad_hyphen: 'keypad_hyphen',
    keypad_plus: 'keypad_plus',
    keypad_enter: 'keypad_enter',
    keypad_1: 'keypad_1',
    keypad_2: 'keypad_2',
    keypad_3: 'keypad_3',
    keypad_4: 'keypad_4',
    keypad_5: 'keypad_5',
    keypad_6: 'keypad_6',
    keypad_7: 'keypad_7',
    keypad_8: 'keypad_8',
    keypad_9: 'keypad_9',
    keypad_0: 'keypad_0',
    keypad_period: 'keypad_period',
    keypad_equal_sign: 'keypad_equal_sign',
    keypad_comma: 'keypad_comma',
    print_screen: 'print_screen',
    scroll_lock: 'scroll_lock',
    pause: 'pause',
    insert: 'insert',
    application: 'application',
    help: 'help',
    power: 'power',
    international1: 'international1',
    international3: 'international3',
    lang1: 'lang1',
    lang2: 'lang2',
    japanese_eisuu: 'japanese_eisuu',
    japanese_kana: 'japanese_kana',
    volume_down: 'volume_down',
    volume_up: 'volume_up',
    mute: 'mute',
    volume_decrement: 'volume_decrement',
    volume_increment: 'volume_increment',
  },
  dvorak_logical: {
    q: 'x',
    w: 'comma',
    e: 'd',
    r: 'o',
    t: 'k',
    y: 't',
    u: 'f',
    i: 'g',
    o: 's',
    p: 'r',
    a: 'a',
    s: 'semicolon',
    d: 'h',
    f: 'y',
    g: 'u',
    h: 'j',
    j: 'c',
    k: 'v',
    l: 'p',
    semicolon: 'z',
    z: 'slash',
    x: 'b',
    c: 'i',
    v: 'period',
    b: 'n',
    n: 'l',
    m: 'm',
    comma: 'w',
    period: 'e',
    slash: 'open_bracket',
    grave_accent_and_tilde: 'grave_accent_and_tilde',
    '1': '1',
    '2': '2',
    '3': '3',
    '4': '4',
    '5': '5',
    '6': '6',
    '7': '7',
    '8': '8',
    '9': '9',
    '0': '0',
    quote: 'q',
    backslash: 'backslash',
    hyphen: 'hyphen',
    equal_sign: 'equal_sign',
    open_bracket: 'open_bracket',
    close_bracket: 'close_bracket',
    left_control: 'left_control',
    left_shift: 'left_shift',
    left_option: 'left_option',
    left_command: 'left_command',
    right_control: 'right_control',
    right_shift: 'right_shift',
    right_option: 'right_option',
    right_command: 'right_command',
    fn: 'fn',
    caps_lock: 'caps_lock',
    return_or_enter: 'return_or_enter',
    escape: 'escape',
    delete_or_backspace: 'delete_or_backspace',
    delete_forward: 'delete_forward',
    tab: 'tab',
    spacebar: 'spacebar',
    non_us_pound: 'non_us_pound',
    non_us_backslash: 'non_us_backslash',
    up_arrow: 'up_arrow',
    down_arrow: 'down_arrow',
    left_arrow: 'left_arrow',
    right_arrow: 'right_arrow',
    page_up: 'page_up',
    page_down: 'page_down',
    home: 'home',
    end: 'end',
    f1: 'f1',
    f2: 'f2',
    f3: 'f3',
    f4: 'f4',
    f5: 'f5',
    f6: 'f6',
    f7: 'f7',
    f8: 'f8',
    f9: 'f9',
    f10: 'f10',
    f11: 'f11',
    f12: 'f12',
    f13: 'f13',
    f14: 'f14',
    f15: 'f15',
    f16: 'f16',
    f17: 'f17',
    f18: 'f18',
    f19: 'f19',
    f20: 'f20',
    keypad_num_lock: 'keypad_num_lock',
    keypad_slash: 'keypad_slash',
    keypad_asterisk: 'keypad_asterisk',
    keypad_hyphen: 'keypad_hyphen',
    keypad_plus: 'keypad_plus',
    keypad_enter: 'keypad_enter',
    keypad_1: 'keypad_1',
    keypad_2: 'keypad_2',
    keypad_3: 'keypad_3',
    keypad_4: 'keypad_4',
    keypad_5: 'keypad_5',
    keypad_6: 'keypad_6',
    keypad_7: 'keypad_7',
    keypad_8: 'keypad_8',
    keypad_9: 'keypad_9',
    keypad_0: 'keypad_0',
    keypad_period: 'keypad_period',
    keypad_equal_sign: 'keypad_equal_sign',
    keypad_comma: 'keypad_comma',
    print_screen: 'print_screen',
    scroll_lock: 'scroll_lock',
    pause: 'pause',
    insert: 'insert',
    application: 'application',
    help: 'help',
    power: 'power',
    international1: 'international1',
    international3: 'international3',
    lang1: 'lang1',
    lang2: 'lang2',
    japanese_eisuu: 'japanese_eisuu',
    japanese_kana: 'japanese_kana',
    volume_down: 'volume_down',
    volume_up: 'volume_up',
    mute: 'mute',
    volume_decrement: 'volume_decrement',
    volume_increment: 'volume_increment',
  },
}

// fix location on keyboard, regardless of letter that will return in that positio/**
const getLocation = (config: ProfileConfig): LocationLayoutMap => {
     return config.layout === 'qwerty' || !config.hardwareTranslation
       ? layouts['qwerty']
       : layouts[config.layout]
}

// type a specific letter on keyboard, regardless of position
const getLetter = (config: ProfileConfig): LocationLayoutMap => {
  return config.layout === 'qwerty' || config.hardwareTranslation
    ? layouts['qwerty']
    : layouts[`${config.layout}_logical` as Layout]
}

const getLayer = (config: ProfileConfig): LocationLayerMap => {
  const layoutMap = getLocation(config)

  return Object.entries(layoutMap).reduce((acc, [key, value]) => {
    try {
      const layerKey = key as LayerKeyParam
      const layerValue = value as LayerKeyParam
      acc[layerKey] = layerValue
    } catch {}
    return acc
  }, {} as LocationLayerMap)
}

export const getLayerConfig = (config: ProfileConfig): LayerConfig => {

  return {
    letter: getLetter(config),
    location: getLocation(config),
    layerLocation: getLayer(config),
    profileName: config.profileName,
  }
}
